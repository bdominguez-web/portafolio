import React, { useState, useEffect, useMemo, useRef } from 'react';
import { PieChart, Pie, Cell, ResponsiveContainer, Tooltip, Legend } from 'recharts';
import { Check, ChevronDown, PieChart as IconPie, DollarSign, List, Filter, Trash2, Upload, Coins, Wallet, FileSpreadsheet, RefreshCw, TrendingUp, AlertCircle, ArrowDown, TrendingDown, Percent, Calendar, Calculator, ArrowRight, Save, Plus, BarChart3, PieChart as PieIcon } from 'lucide-react';

// Colores vibrantes y profesionales
const COLORS = {
  'Renta Fija': '#2563EB', // Azul Real
  'Renta Variable': '#059669', // Verde Esmeralda
  'Commodities': '#D97706', // Ámbar
  'Cash': '#475569', // Gris
  'Sin Clasificar': '#E2E8F0' // Gris Claro
};

const BG_COLORS = {
  'Renta Fija': 'bg-blue-50',
  'Renta Variable': 'bg-emerald-50',
  'Commodities': 'bg-amber-50',
  'Cash': 'bg-slate-100',
  'Sin Clasificar': 'bg-slate-50'
};

const TEXT_COLORS = {
  'Renta Fija': 'text-blue-700',
  'Renta Variable': 'text-emerald-700',
  'Commodities': 'text-amber-700',
  'Cash': 'text-slate-700',
  'Sin Clasificar': 'text-slate-400'
};

const CATEGORIES = ['Renta Fija', 'Renta Variable', 'Commodities', 'Cash', 'Sin Clasificar'];

// Datos iniciales vacíos
const INITIAL_DATA = [];

// --- LÓGICA DE FECHAS DINÁMICAS ---
const getToday = () => new Date().toISOString().split('T')[0];

const getYesterday = () => {
    const d = new Date();
    d.setDate(d.getDate() - 1);
    return d.toISOString().split('T')[0];
};

// Último día del año anterior (Para YTD)
const getLastDayOfPreviousYear = () => {
    const d = new Date();
    return `${d.getFullYear() - 1}-12-31`;
};

// Último día HÁBIL del mes anterior (Para MTD)
const getLastBusinessDayOfPreviousMonth = () => {
    const d = new Date();
    d.setDate(1); // Vamos al 1 del mes actual
    d.setHours(-24); // Retrocedemos al último día del mes anterior
    
    // Si cae Sábado (6) retrocedemos 1 día a Viernes
    if (d.getDay() === 6) {
        d.setDate(d.getDate() - 1);
    } 
    // Si cae Domingo (0) retrocedemos 2 días a Viernes
    else if (d.getDay() === 0) {
        d.setDate(d.getDate() - 2);
    }
    
    return d.toISOString().split('T')[0];
};

// Periodos predeterminados con lógica inteligente
const INITIAL_PERIODS = [
  { id: 0, name: 'Diario (Variación Hoy)', startDate: getYesterday(), initial: 0, movements: 0, type: 'daily' },
  { id: 1, name: 'MTD (Mes Actual)', startDate: getLastBusinessDayOfPreviousMonth(), initial: 0, movements: 0, type: 'mtd' },
  { id: 2, name: 'YTD (Año Actual)', startDate: getLastDayOfPreviousYear(), initial: 0, movements: 0, type: 'ytd' },
  { id: 3, name: 'Histórico (Total)', startDate: '2025-09-28', initial: 0, movements: 0, type: 'hist' },
];

const Card = ({ children, className = "" }) => (
  <div className={`bg-white rounded-xl shadow-md border border-slate-200 overflow-hidden ${className}`}>
    {children}
  </div>
);

// Componente para input numérico editable mejorado
const EditableMetricInput = ({ value, onChange, placeholder = "0,00" }) => {
  return (
    <div className="relative group w-full">
      <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none font-bold">$</span>
      <input
        type="number"
        value={value === 0 ? '' : value}
        onChange={(e) => onChange(parseFloat(e.target.value) || 0)}
        placeholder={placeholder}
        className="w-full pl-6 pr-3 py-2 text-right text-sm font-mono border border-slate-200 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none bg-white hover:border-slate-300 transition-all text-slate-700 font-bold placeholder:text-slate-300 shadow-sm"
      />
    </div>
  );
};

// Componente para input de fecha editable
const EditableDateInput = ({ value, onChange }) => {
  return (
    <div className="relative group w-full">
      <input
        type="date"
        value={value || ''}
        onChange={(e) => onChange(e.target.value)}
        className="w-full px-3 py-2 text-sm font-mono border border-slate-200 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none bg-white hover:border-slate-300 transition-all text-slate-600 shadow-sm"
      />
    </div>
  );
};

// Formateadores Consistentes (Estilo 1.000,00)
const formatCurrency = (val) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(val);
const formatNumber = (val) => new Intl.NumberFormat('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(val);

export default function PortfolioClassifier() {
  const [assets, setAssets] = useState(INITIAL_DATA);
  const [periods, setPeriods] = useState(INITIAL_PERIODS);
  const [selectedIds, setSelectedIds] = useState(new Set());
  const [loading, setLoading] = useState(false);
  const fileInputRef = useRef(null);
  const performanceRef = useRef(null);
  const compositionRef = useRef(null);

  // Calcular métricas globales de activos
  const stats = useMemo(() => {
    const totalCurrentValue = assets.reduce((sum, asset) => sum + asset.amount, 0);
    
    // Agrupación por categoría
    const byCategory = CATEGORIES.reduce((acc, cat) => { acc[cat] = 0; return acc; }, {});
    assets.forEach(asset => { byCategory[asset.category] += asset.amount; });

    const chartData = Object.keys(byCategory)
      .filter(key => byCategory[key] > 0)
      .map(key => ({
        name: key, value: byCategory[key], percentage: totalCurrentValue ? (byCategory[key] / totalCurrentValue) * 100 : 0
      }))
      .sort((a, b) => b.value - a.value);

    // Calcular datos de rendimiento global para cada periodo
    const calculatedPeriods = periods.map(period => {
      const invested = (period.initial || 0) + (period.movements || 0);
      const result = totalCurrentValue - invested;
      
      let yieldPct = 0;
      if (invested !== 0) {
        yieldPct = (result / Math.abs(invested)) * 100;
      } else if (result > 0) {
          yieldPct = 100;
      }

      return { ...period, final: totalCurrentValue, result, yieldPct };
    });

    return { 
      totalCurrentValue, 
      byCategory, 
      chartData,
      calculatedPeriods
    };
  }, [assets, periods]);

  // Manejadores
  const handlePeriodChange = (id, field, value) => {
    setPeriods(prev => prev.map(p => p.id === id ? { ...p, [field]: value } : p));
  };

  const handleCategoryChange = (id, newCategory) => {
    setAssets(prev => prev.map(asset => asset.id === id ? { ...asset, category: newCategory } : asset));
  };

  const toggleSelect = (id) => {
    const newSelected = new Set(selectedIds);
    if (newSelected.has(id)) newSelected.delete(id); else newSelected.add(id);
    setSelectedIds(newSelected);
  };

  const toggleSelectAll = () => {
    setSelectedIds(selectedIds.size === assets.length ? new Set() : new Set(assets.map(a => a.id)));
  };

  const handleBulkCategorize = (category) => {
    setAssets(prev => prev.map(asset => selectedIds.has(asset.id) ? { ...asset, category } : asset));
    setSelectedIds(new Set());
  };

  const scrollToPerformance = () => performanceRef.current?.scrollIntoView({ behavior: 'smooth' });
  const scrollToComposition = () => compositionRef.current?.scrollIntoView({ behavior: 'smooth' });

  // Lector CSV
  const handleFileUpload = (event) => {
    const file = event.target.files[0];
    if (!file) return;

    setLoading(true);
    const reader = new FileReader();

    reader.onload = (e) => {
      try {
        const text = e.target.result;
        const rows = text.split('\n');
        const newAssets = [];
        
        const headerRow = rows.find(r => r.toUpperCase().includes('DETALLE') || r.toUpperCase().includes('CATEGOR')) || rows[0];
        const isSemicolon = headerRow && headerRow.includes(';');
        const separator = isSemicolon ? ';' : ',';
        
        let headerIndex = -1;
        let colMap = { type: -1, name: -1, currency: -1, price: -1, quantity: -1, amount: -1 };

        for (let i = 0; i < rows.length; i++) {
          const rowUpper = rows[i].toUpperCase();
          if (rowUpper.includes('DETALLE') || rowUpper.includes('CATEGOR')) {
            headerIndex = i;
            const cols = rows[i].split(separator).map(c => c.trim().toUpperCase().replace(/"/g, ''));
            cols.forEach((col, index) => {
              if (col.includes('CATEGOR')) colMap.type = index;
              if (col.includes('DETALLE') || col.includes('ACTIVO')) colMap.name = index;
              if (col.includes('MONEDA')) colMap.currency = index;
              if (col.includes('COTIZA') || col.includes('PRECIO')) colMap.price = index;
              if (col === 'CANTIDAD') colMap.quantity = index;
              if (col.includes('MONTO') || col.includes('VALOR')) colMap.amount = index;
            });
            break;
          }
        }

        if (headerIndex === -1 || colMap.name === -1) {
           headerIndex = 0;
           colMap = { type: 0, name: 1, currency: 2, price: 3, quantity: 4, amount: 5 };
        }

        let lastType = 'General';

        for (let i = headerIndex + 1; i < rows.length; i++) {
          const rowRaw = rows[i].trim();
          if (!rowRaw) continue;
          const cols = rowRaw.split(separator);
          if (cols.length < 3) continue;

          let typeRaw = cols[colMap.type]?.trim().replace(/"/g, '');
          let name = cols[colMap.name]?.trim().replace(/"/g, '');
          let currency = cols[colMap.currency]?.trim().replace(/"/g, '');
          
          const cleanNumber = (val) => {
            if (!val) return 0;
            let clean = val.trim().replace(/[A-Za-z$%\s]/g, '');
            if (isSemicolon) clean = clean.replace(/\./g, '').replace(',', '.');
            else clean = clean.replace(/,/g, '');
            return parseFloat(clean) || 0;
          };

          const price = cleanNumber(cols[colMap.price]);
          const quantity = cleanNumber(cols[colMap.quantity]);
          const amount = cleanNumber(cols[colMap.amount]);

          if (typeRaw && typeRaw.length > 1) lastType = typeRaw;
          if (!name || name.toUpperCase() === 'TOTAL' || (amount === 0 && price === 0)) continue;
          if (name.includes('Subtotal') || name.includes('Total Cartera')) continue;

          newAssets.push({
            id: i,
            type: lastType, name, currency: currency || '-',
            price, quantity, amount, category: 'Sin Clasificar'
          });
        }

        if (newAssets.length > 0) {
          setAssets(newAssets);
          setSelectedIds(new Set());
        } else {
          alert("No se encontraron datos válidos.");
        }
      } catch (error) {
        console.error("Error parsing CSV:", error);
        alert("Error al leer archivo.");
      }
      setLoading(false);
      if(fileInputRef.current) fileInputRef.current.value = '';
    };
    reader.readAsText(file);
  };

  const triggerFileInput = () => fileInputRef.current.click();

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-800 p-4 md:p-8">
      <div className="max-w-[1600px] mx-auto space-y-8">
        
        {/* HEADER */}
        <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex flex-col md:flex-row justify-between items-center gap-6">
          <div className="flex items-center gap-4">
             <div className="bg-indigo-600 p-3 rounded-xl shadow-md transform rotate-3">
                <IconPie className="text-white" size={32} />
             </div>
             <div>
                <h1 className="text-2xl font-extrabold text-slate-900 tracking-tight">Portfolio Manager</h1>
                <p className="text-slate-500 font-medium text-sm">Análisis y Rendimiento de Activos</p>
             </div>
          </div>
          <div className="flex items-center gap-4">
            <input type="file" accept=".csv" ref={fileInputRef} onChange={handleFileUpload} className="hidden" />
            <button onClick={triggerFileInput} disabled={loading} className="flex items-center gap-2 px-6 py-3 bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 rounded-xl font-bold shadow-sm transition-all hover:shadow-md hover:border-indigo-200 group">
              {loading ? <RefreshCw className="animate-spin text-indigo-600" size={20} /> : <Upload size={20} className="text-indigo-600 group-hover:scale-110 transition-transform" />}
              {loading ? 'Procesando...' : 'Importar CSV'}
            </button>
            <div className="hidden md:flex flex-col items-end px-6 border-l border-slate-100">
               <span className="text-xs uppercase font-bold tracking-wider text-slate-400">Patrimonio Total</span>
               <span className="text-3xl font-black text-slate-900 leading-none mt-1">{formatCurrency(stats.totalCurrentValue)}</span>
            </div>
          </div>
        </div>

        {/* --- SECCIÓN 1: INVENTARIO DE ACTIVOS (Tabla) --- */}
        <Card className="flex flex-col min-h-[400px] shadow-lg border-0 ring-1 ring-slate-200">
          <div className="p-5 border-b border-slate-100 bg-white flex flex-col sm:flex-row justify-between items-center gap-4 sticky top-0 z-20">
            <div className="flex items-center gap-3">
              <div className="bg-slate-100 p-2 rounded-lg text-slate-500"><List size={20} /></div>
              <h2 className="font-bold text-lg text-slate-800">Inventario de Posiciones</h2>
              <span className="bg-indigo-50 text-indigo-700 text-xs font-bold px-3 py-1 rounded-full">{assets.length} items</span>
            </div>
            
            <div className="flex items-center gap-4">
              {selectedIds.size > 0 && (
                <div className="flex items-center gap-3 bg-indigo-50 px-4 py-2 rounded-lg border border-indigo-100 animate-in fade-in slide-in-from-right-4">
                  <span className="text-sm font-semibold text-indigo-700">{selectedIds.size} seleccionados</span>
                  <div className="relative group">
                    <button className="text-indigo-700 text-sm font-bold flex items-center gap-1 hover:underline">Clasificar <ChevronDown size={16} /></button>
                    <div className="absolute right-0 top-full mt-2 w-48 bg-white rounded-xl shadow-xl border border-slate-100 hidden group-hover:block z-50">
                      {CATEGORIES.filter(c => c !== 'Sin Clasificar').map(cat => (
                        <button key={cat} onClick={() => handleBulkCategorize(cat)} className="w-full text-left px-4 py-3 text-sm hover:bg-slate-50 text-slate-700 flex items-center gap-2 border-b border-slate-50 last:border-0">
                          <span className="w-2.5 h-2.5 rounded-full" style={{ backgroundColor: COLORS[cat] }}></span> {cat}
                        </button>
                      ))}
                    </div>
                  </div>
                </div>
              )}
              <button onClick={scrollToComposition} className="text-slate-400 hover:text-indigo-600 hidden sm:flex items-center gap-1 text-sm font-medium transition-colors">
                Ver Análisis <ArrowDown size={16} />
              </button>
            </div>
          </div>

          <div className="flex-1 overflow-auto custom-scrollbar max-h-[45vh]">
            <table className="w-full text-left border-collapse">
              <thead className="sticky top-0 z-10 bg-slate-50 shadow-sm border-b border-slate-200">
                <tr>
                  <th className="p-4 w-10 text-center"><input type="checkbox" className="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer" checked={selectedIds.size === assets.length && assets.length > 0} onChange={toggleSelectAll} /></th>
                  <th className="px-3 py-3 text-xs font-bold text-slate-500 uppercase tracking-wider">Tipo</th>
                  <th className="px-3 py-3 text-xs font-bold text-slate-500 uppercase tracking-wider min-w-[300px]">Activo</th>
                  <th className="px-3 py-3 text-xs font-bold text-slate-500 uppercase tracking-wider text-right w-32">Precio</th>
                  <th className="px-3 py-3 text-xs font-bold text-slate-500 uppercase tracking-wider text-right w-32">Cantidad</th>
                  <th className="px-3 py-3 text-xs font-bold text-slate-800 uppercase tracking-wider text-right w-40 bg-slate-100/50 border-l border-slate-200">Valor Total</th>
                  <th className="px-4 py-3 text-xs font-bold text-indigo-600 uppercase tracking-wider w-48 pl-6">Categoría</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-slate-100 bg-white">
                {assets.map((asset) => (
                  <tr key={asset.id} className={`group transition-colors hover:bg-slate-50 ${selectedIds.has(asset.id) ? 'bg-indigo-50/60' : ''}`}>
                    <td className="p-4 text-center"><input type="checkbox" className="rounded border-slate-300 text-indigo-600 cursor-pointer" checked={selectedIds.has(asset.id)} onChange={() => toggleSelect(asset.id)} /></td>
                    <td className="px-3 py-3 align-middle"><span className="px-2 py-0.5 rounded text-[10px] font-bold uppercase bg-slate-100 text-slate-600 border border-slate-200">{asset.type || '-'}</span></td>
                    <td className="px-3 py-3 align-middle">
                      <div className="flex items-center gap-3">
                         <div className={`p-1.5 rounded-full ${asset.type === 'Moneda' ? 'bg-amber-100 text-amber-600' : 'bg-blue-50 text-blue-500'}`}>
                            {asset.type === 'Moneda' ? <Coins size={14} /> : <Wallet size={14} />}
                         </div>
                         <div><span className="text-sm font-semibold text-slate-900 block truncate max-w-[400px]" title={asset.name}>{asset.name}</span><span className="text-[10px] text-slate-400 font-mono">{asset.currency} | {formatNumber(asset.price)}</span></div>
                      </div>
                    </td>
                    <td className="px-3 py-3 text-right font-mono text-sm text-slate-600 align-middle">{formatNumber(asset.price)}</td>
                    <td className="px-3 py-3 text-right font-mono text-sm text-slate-600 align-middle">{formatNumber(asset.quantity)}</td>
                    <td className="px-3 py-3 text-right font-mono text-sm font-bold text-slate-900 bg-slate-50/30 border-l border-slate-100 align-middle">{formatCurrency(asset.amount)}</td>
                    <td className="px-4 py-3 align-middle">
                      <select value={asset.category} onChange={(e) => handleCategoryChange(asset.id, e.target.value)}
                        className={`block w-full rounded-lg border-0 py-1.5 pl-2 pr-8 text-xs font-bold cursor-pointer ring-1 ring-inset focus:ring-2 focus:ring-indigo-600 ${asset.category === 'Sin Clasificar' ? 'text-slate-400 bg-white ring-slate-200' : `${BG_COLORS[asset.category]} ${TEXT_COLORS[asset.category]} ring-transparent`}`}>
                        {CATEGORIES.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                      </select>
                    </td>
                  </tr>
                ))}
                {assets.length === 0 && <tr><td colSpan="7" className="p-16 text-center text-slate-400"><FileSpreadsheet size={48} className="mx-auto mb-3 opacity-30"/><p>Sube tu archivo CSV para comenzar.</p></td></tr>}
              </tbody>
            </table>
          </div>
        </Card>

        {/* --- SECCIÓN 2: DISTRIBUCIÓN Y ANÁLISIS (Mejorado) --- */}
        <div ref={compositionRef} className="grid grid-cols-1 lg:grid-cols-12 gap-8">
          
          {/* Gráfico Donut */}
          <div className="lg:col-span-5 flex flex-col gap-4">
             <div className="flex items-center gap-2">
                <PieIcon className="text-indigo-600" size={24}/>
                <h2 className="text-xl font-bold text-slate-800">Distribución de Activos</h2>
             </div>
             <Card className="p-8 h-full min-h-[380px] flex items-center justify-center relative bg-gradient-to-br from-white to-slate-50">
               <div className="h-72 w-full relative">
                 <ResponsiveContainer width="100%" height="100%">
                   <PieChart>
                     <Pie 
                        data={stats.chartData} 
                        cx="50%" 
                        cy="50%" 
                        innerRadius={85} 
                        outerRadius={115} 
                        paddingAngle={4} 
                        dataKey="value" 
                        stroke="none"
                        cornerRadius={6}
                     >
                       {stats.chartData.map((entry, index) => <Cell key={`cell-${index}`} fill={COLORS[entry.name]} />)}
                     </Pie>
                     <Tooltip formatter={(value) => formatCurrency(value)} contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 12px rgba(0,0,0,0.1)' }}/>
                   </PieChart>
                 </ResponsiveContainer>
                 {/* Centro del Donut */}
                 <div className="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                   <span className="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Total</span>
                   <span className="text-3xl font-black text-slate-800 tracking-tight">{formatCurrency(stats.totalCurrentValue)}</span>
                   <span className="text-[10px] text-slate-400 mt-1">{assets.length} posiciones</span>
                 </div>
               </div>
             </Card>
          </div>

          {/* Lista de Detalles (Visualmente Mejorada) */}
          <div className="lg:col-span-7 flex flex-col gap-4">
             <div className="flex items-center gap-2">
                <BarChart3 className="text-slate-500" size={24}/>
                <h2 className="text-xl font-bold text-slate-800">Detalle por Estrategia</h2>
             </div>
             <Card className="p-6 h-full min-h-[380px] bg-white">
               <div className="space-y-5">
                 {stats.chartData.map((item) => (
                   <div key={item.name} className="group">
                     <div className="flex justify-between items-end mb-2">
                       <div className="flex items-center gap-3">
                         <div className={`p-2 rounded-lg ${BG_COLORS[item.name]}`}>
                            <div className="w-3 h-3 rounded-full shadow-sm" style={{ backgroundColor: COLORS[item.name] }}></div>
                         </div>
                         <div>
                            <span className="text-sm font-bold text-slate-700 block">{item.name}</span>
                            <span className="text-xs text-slate-400 font-medium">{item.percentage.toFixed(2)}% del portafolio</span>
                         </div>
                       </div>
                       <div className="text-right">
                          <span className="text-base font-bold text-slate-900 block font-mono">{formatCurrency(item.value)}</span>
                       </div>
                     </div>
                     {/* Barra de Progreso Mejorada */}
                     <div className="w-full bg-slate-100 rounded-full h-3 overflow-hidden shadow-inner">
                       <div 
                         className="h-full rounded-full transition-all duration-1000 ease-out relative overflow-hidden" 
                         style={{ width: `${item.percentage}%`, backgroundColor: COLORS[item.name] }}
                       >
                          {/* Efecto de brillo */}
                          <div className="absolute top-0 left-0 right-0 bottom-0 bg-gradient-to-b from-white/20 to-transparent"></div>
                       </div>
                     </div>
                   </div>
                 ))}
                 {stats.chartData.length === 0 && (
                    <div className="flex flex-col items-center justify-center h-64 text-slate-400 opacity-60">
                       <PieIcon size={48} className="mb-2"/>
                       <p className="text-sm italic">Clasifica tus activos para ver el análisis.</p>
                    </div>
                 )}
               </div>
             </Card>
          </div>
        </div>

        {/* --- SECCIÓN 3: CALCULADORA DE RENDIMIENTOS (Footer) --- */}
        <div ref={performanceRef} className="w-full pb-12 pt-4 border-t border-slate-200">
           <div className="flex items-center justify-between mb-6">
              <div className="flex items-center gap-3">
                <div className="bg-emerald-100 p-2 rounded-lg text-emerald-600"><Calculator size={24}/></div>
                <div>
                    <h2 className="text-xl font-bold text-slate-800">Calculadora de Rentabilidad</h2>
                    <p className="text-sm text-slate-500">Ingresa saldos iniciales y movimientos para calcular el retorno</p>
                </div>
              </div>
           </div>

           <Card className="p-0 border-0 shadow-xl ring-1 ring-slate-200 overflow-visible bg-white">
              <div className="overflow-x-auto">
                 <table className="w-full text-left border-collapse">
                    <thead>
                       <tr className="bg-slate-900 text-white">
                          <th className="px-6 py-5 text-xs font-bold uppercase tracking-wider rounded-tl-xl w-[20%]">Periodo de Análisis</th>
                          <th className="px-4 py-5 text-xs font-bold uppercase tracking-wider w-[15%]">Fecha Desde</th>
                          <th className="px-4 py-5 text-xs font-bold uppercase tracking-wider text-right w-[15%]">Saldo Inicial</th>
                          <th className="px-4 py-5 text-xs font-bold uppercase tracking-wider text-right w-[15%]">Movimientos Netos</th>
                          <th className="px-4 py-5 text-xs font-bold uppercase tracking-wider text-right bg-slate-800 w-[15%]">Saldo Final</th>
                          <th className="px-4 py-5 text-xs font-bold uppercase tracking-wider text-right w-[10%]">Resultado</th>
                          <th className="px-6 py-5 text-xs font-bold uppercase tracking-wider text-right rounded-tr-xl w-[10%]">% Rendimiento</th>
                       </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-slate-100">
                       {stats.calculatedPeriods.map((period) => (
                          <tr key={period.id} className="hover:bg-slate-50 transition-colors group">
                             <td className="px-6 py-4 font-bold text-slate-700 text-sm align-middle border-l-4 border-transparent hover:border-indigo-500 transition-all">
                                {period.name}
                                {period.type === 'daily' && <span className="ml-2 inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold bg-emerald-100 text-emerald-800 border border-emerald-200">HOY</span>}
                             </td>
                             <td className="px-4 py-4 align-middle">
                                <EditableDateInput
                                  value={period.startDate}
                                  onChange={(val) => handlePeriodChange(period.id, 'startDate', val)}
                                />
                             </td>
                             <td className="px-4 py-4 align-middle">
                                <EditableMetricInput 
                                  value={period.initial} 
                                  onChange={(val) => handlePeriodChange(period.id, 'initial', val)} 
                                  placeholder="Inicial"
                                />
                             </td>
                             <td className="px-4 py-4 align-middle">
                                <EditableMetricInput 
                                  value={period.movements} 
                                  onChange={(val) => handlePeriodChange(period.id, 'movements', val)} 
                                  placeholder="Netos"
                                />
                             </td>
                             <td className="px-4 py-4 text-right font-mono text-sm font-bold text-slate-800 bg-slate-50/80 align-middle">
                                {formatCurrency(period.final)}
                             </td>
                             <td className="px-4 py-4 text-right align-middle">
                                <span className={`font-mono font-bold text-sm ${period.result >= 0 ? 'text-emerald-600' : 'text-rose-600'}`}>
                                  {period.result > 0 ? '+' : ''}{formatCurrency(period.result)}
                                </span>
                             </td>
                             <td className="px-6 py-4 text-right align-middle">
                                {(period.initial > 0 || period.movements !== 0 || period.result !== 0) ? (
                                  <span className={`inline-flex items-center px-3 py-1.5 rounded-lg text-sm font-bold shadow-sm ${period.yieldPct >= 0 ? 'bg-emerald-100 text-emerald-700 ring-1 ring-emerald-200' : 'bg-rose-100 text-rose-700 ring-1 ring-rose-200'}`}>
                                    {period.yieldPct > 0 ? <TrendingUp size={14} className="mr-1.5"/> : <TrendingDown size={14} className="mr-1.5"/>}
                                    {period.yieldPct.toFixed(2)}%
                                  </span>
                                ) : (
                                  <span className="text-slate-300 font-mono">-</span>
                                )}
                             </td>
                          </tr>
                       ))}
                    </tbody>
                 </table>
              </div>
              <div className="p-4 bg-slate-50 text-xs text-slate-500 border-t border-slate-200 flex justify-between items-center">
                 <span>* El <strong>Saldo Final</strong> se calcula automáticamente sumando el valor actual de todos los activos ({formatCurrency(stats.totalCurrentValue)}).</span>
                 <span>Fórmula: Resultado = Final - (Inicial + Movimientos)</span>
              </div>
           </Card>
        </div>

      </div>
    </div>
  );
}